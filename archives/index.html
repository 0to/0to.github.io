
<!DOCTYPE html>
<html lang="en,zh-cn,default">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Just Do IT">
    <title>Archives - Just Do IT</title>
    <meta name="author" content="Weilong">
    
    
        <link rel="icon" href="https://0to.github.io/assets/images/owl.png">
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <script type="application/ld+json">{}</script>
    <meta name="description" content="小弟读过两年书，尘世中一个迷途小书童。">
<meta property="og:type" content="blog">
<meta property="og:title" content="Just Do IT">
<meta property="og:url" content="https://0to.github.io/archives/index.html">
<meta property="og:site_name" content="Just Do IT">
<meta property="og:description" content="小弟读过两年书，尘世中一个迷途小书童。">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Just Do IT">
<meta name="twitter:description" content="小弟读过两年书，尘世中一个迷途小书童。">
    
    
        
    
    
        <meta property="og:image" content="https://0to.github.io/assets/images/owl.png"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/all.css">
    <link rel="stylesheet" href="/assets/css/jquery.fancybox.css">
    <link rel="stylesheet" href="/assets/css/thumbs.css">
    <link rel="stylesheet" href="/assets/css/tranquilpeak.css">
    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-85893233-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-85893233-1');
    </script>


    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?c9c4d3aced97237b37b08c97b10e7d3e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="2">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/ "
            aria-label=""
        >
            Just Do IT
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/owl.png" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="2">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/owl.png" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Weilong</h4>
                
                    <h5 class="sidebar-profile-bio"> <ul> Write something about work and life: <ul class="nav pull-left"> <li align="left">Project management</li> <li align="left">Configuration management</li> <li align="left">Process improvement</li> <li align="left">Continuous deploy</li> <li align="left">Python program</li> </ul><br></ul> </h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                            title="Categories"
                        >
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archives"
                        >
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link open-algolia-search"
                             href="#search"
                            
                            title="Search"
                        >
                    
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="#about"
                            
                            title="About"
                        >
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/0to" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://cn.linkedin.com/in/龙-威-73303298" target="_blank" rel="noopener" title="LinkedIn">
                    
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="mailto:326688025@qq.com" target="_blank" rel="noopener" title="Mail">
                    
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/atom.xml"
                            
                            title="RSS"
                        >
                    
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="2"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/posts/22197/"
                            aria-label=": Centos7 升级git版本 - 源码编译安装"
                        >
                            Centos7 升级git版本 - 源码编译安装
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-10-13T14:30:06+08:00">
	
		    Oct 13, 2020
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/SCM/">SCM</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>原生Centos7系统的yum源自带git版本是1.8.3.1。</p>
<p>这个版本诞生于：10-Jun-2013。</p>
<p>很多新特性都不支持，为了更好的使用git，我们需要进行版本升级。</p>
<h1 id="源码编译安装"><a href="#源码编译安装" class="headerlink" title="源码编译安装"></a>源码编译安装</h1><ol>
<li><p>安装相关依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># yum install curl-devel expat-devel gettext-devel openssl-devel zlib-devel asciidoc</span><br><span class="line"># yum install  gcc perl-ExtUtils-MakeMaker</span><br></pre></td></tr></table></figure>
</li>
<li><p>卸载当前git</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum remove git</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载新版本源码包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">官方仓库地址：https://mirrors.edge.kernel.org/pub/software/scm/git/</span><br><span class="line">当前最新版本：git-2.28.0.tar.xz       27-Jul-2020</span><br><span class="line"></span><br><span class="line"># wget https://mirrors.edge.kernel.org/pub/software/scm/git/git-2.28.0.tar.xz</span><br></pre></td></tr></table></figure>
</li>
<li><p>源码编译安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># tar -xvf git-2.28.0.tar.xz</span><br><span class="line"># cd git-2.28.0/</span><br><span class="line"># which openssl  获取本机openssl路径，当前机器/usr/bin/openssl</span><br><span class="line"># ./configure --with-openssl=/usr/bin/openssl</span><br><span class="line"># make prefix=/usr/local/git all</span><br><span class="line"># make prefix=/usr/local/git install</span><br><span class="line"># echo &quot;export PATH=$PATH:/usr/local/git/bin&quot; &gt;&gt; /etc/profile</span><br><span class="line"># source /etc/profile</span><br></pre></td></tr></table></figure>
</li>
</ol>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/posts/22197/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/posts/15762/"
                            aria-label=": Jenkins Windows batch build stuck on final exit"
                        >
                            Jenkins Windows batch build stuck on final exit
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-07-10T00:45:02+08:00">
	
		    Jul 10, 2020
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/SCM/">SCM</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="系统软件环境"><a href="#系统软件环境" class="headerlink" title="系统软件环境"></a>系统软件环境</h1><table>
<thead>
<tr>
<th>系统软件</th>
<th>版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>Jenkins</td>
<td>2.150.2</td>
</tr>
<tr>
<td>Slave</td>
<td>Windows 10</td>
</tr>
</tbody>
</table>
<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>部分 Windows slave job 执行时间较长，日志分析发现不是Job脚本更新导致，而是因为Jenkins退出卡住。<br>日志分析：<img src="/posts/15762/jenkins1.png" alt="案例"><br>具体任务在13:41就已经执行完成，但是Jenkins在13:51才退出返回结果。<br>也就是说整整卡住了10分钟，必须要解决。</p>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>Jenkins 在 2.14 版本引入了 killSoftly 特性，出发点是想更加优雅的结束进程。<br>但是导致了 Windows slave上的 batch 脚本 执行完成 返回结果卡住（时间不确定）的情况。<br>Linux slave上的 shell 脚本执行退出没有发现此问题。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// Firstly try to kill the root process gracefully, then do a forcekill if it does not help (algorithm is described in JENKINS-17116)</span><br><span class="line"></span><br><span class="line">killSoftly();</span><br></pre></td></tr></table></figure></p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>可以通过 在Windows slave连接master机器的时候 增加 这个参数 -DSoftKillWaitSeconds=0 来解决。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Run from agent command line:</span><br><span class="line"></span><br><span class="line">java -Xrs -DSoftKillWaitSeconds=0 -jar agent.jar -jnlpUrl ...</span><br></pre></td></tr></table></figure></p>
<p>使用上述命令重新连接 Master - Slave 后，可以在Slave系统信息界面看到参数生效了。<br><img src="/posts/15762/jenkins2.png" alt="Slave信息"></p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://issues.jenkins-ci.org/browse/JENKINS-55106" target="_blank" rel="noopener">https://issues.jenkins-ci.org/browse/JENKINS-55106</a><br><a href="https://stackoverflow.com/questions/54039226/jenkins-hangs-between-build-and-post-build" target="_blank" rel="noopener">https://stackoverflow.com/questions/54039226/jenkins-hangs-between-build-and-post-build</a></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/posts/15762/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/posts/9613/"
                            aria-label=": 使用SHA256代替MD5进行文件校验"
                        >
                            使用SHA256代替MD5进行文件校验
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-03-09T21:25:45+08:00">
	
		    Mar 09, 2020
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/SYS/">SYS</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>第三方客户审厂过程中，对公司现有流程管理方法工具有些改进建议。<br>其中有一条是：软件映像文件的完整性检验为MD5值，校验码和软件包一起发布，建议采用其它安全性更好的校验算法。</p>
<h1 id="方案调研"><a href="#方案调研" class="headerlink" title="方案调研"></a>方案调研</h1><h4 id="参考链接：-为什么MD5不能用于存储密码"><a href="#参考链接：-为什么MD5不能用于存储密码" class="headerlink" title="参考链接： 为什么MD5不能用于存储密码"></a>参考链接： <a href="https://draveness.me/whys-the-design-password-with-md5" target="_blank" rel="noopener">为什么MD5不能用于存储密码</a></h4><p>MD5 是一种摘要算法，我们也可以叫它哈希函数，哈希函数可以将无限键值空间中的所有键都均匀地映射到一个指定大小的键值空间中。一个好的摘要算法能够帮助我们保证文件的完整性，避免攻击者的恶意篡改。<br>作为一个 1992 年第一次被公开的算法，到今天为止已经被发现了一些致命的漏洞。在任何场景下，我们都应该避免MD5的使用，可以选择更好的摘要算法替代 MD5，例如 SHA256、SHA512。</p>
<h1 id="改进方案"><a href="#改进方案" class="headerlink" title="改进方案"></a>改进方案</h1><ul>
<li>保留现有的md5校验文件（部分客户还在使用）</li>
<li>同时增加SHA256校验文件</li>
</ul>
<h1 id="基础命令使用"><a href="#基础命令使用" class="headerlink" title="基础命令使用"></a>基础命令使用</h1><ol>
<li><p>SHA256</p>
<ul>
<li><p>生成XXX文件sha256值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sha256sum XXX &gt; XXX.sha256</span><br><span class="line"></span><br><span class="line">[root@wangweilong wwl]# sha256sum clean_virus.sh &gt; clean_virus.sh.sha256</span><br></pre></td></tr></table></figure>
</li>
<li><p>追加YYY文件到已有sha256文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sha256sum YYY &gt;&gt; XXX.sha256</span><br><span class="line"></span><br><span class="line">[root@wangweilong wwl]# sha256sum install.log &gt;&gt; clean_virus.sh.sha256</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成的sha256文件内容:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@wangweilong wwl]# cat clean_virus.sh.sha256</span><br><span class="line"></span><br><span class="line">799750ecaf018307e3f3a5b69c69d28635bf047472e99c85f094ef210deb8ac9  clean_virus.sh</span><br><span class="line">328de949506461ffb371cb2e951d25aadb9e94d7c3038bb08aebce42cd8b84ee  install.log</span><br></pre></td></tr></table></figure>
</li>
<li><p>校验方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">下载文件和对应的md5值文件到同一目录下,执行 sha256sum -c XXX.sha256 命令</span><br><span class="line"></span><br><span class="line">[root@wangweilong test]# sha256sum -c clean_virus.sh.sha256</span><br><span class="line"></span><br><span class="line">clean_virus.sh: OK</span><br><span class="line">install.log: OK</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<hr>
<ol start="2">
<li><p>MD5</p>
<ul>
<li><p>生成XXX文件md5值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">md5sum XXX &gt; XXX.md5</span><br><span class="line"></span><br><span class="line">[root@wangweilong wwl]# md5sum clean_virus.sh &gt; clean_virus.sh.md5</span><br></pre></td></tr></table></figure>
</li>
<li><p>追加YYY文件到已有md5文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">md5sum YYY &gt;&gt; XXX.md5</span><br><span class="line"></span><br><span class="line">[root@wangweilong wwl]# md5sum install.log &gt;&gt; clean_virus.sh.md5</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成的md5文件内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@p5-centos6-wangweilong wwl]# cat clean_virus.sh.md5</span><br><span class="line"></span><br><span class="line">7840489fe303c097fb142a982f9f41e7  clean_virus.sh</span><br><span class="line">16c04079cc2cda26cbab5cfa801df6c6  install.log</span><br></pre></td></tr></table></figure>
</li>
<li><p>校验方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">下载文件和对应的md5值文件到同一目录下,执行md5sum -c XXX.md5 命令</span><br><span class="line">为了更好的展示，我修改了install.log文件的内容</span><br><span class="line"></span><br><span class="line">[root@wangweilong test]# md5sum -c clean_virus.sh.md5</span><br><span class="line"></span><br><span class="line">clean_virus.sh: OK</span><br><span class="line">install.log: FAILED</span><br><span class="line">md5sum: WARNING: 1 of 2 computed checksums did NOT match</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/posts/9613/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/posts/43943/"
                            aria-label=": Jira&amp;&amp;Confluence-简介"
                        >
                            Jira&amp;&amp;Confluence-简介
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-11-28T10:56:15+08:00">
	
		    Nov 28, 2019
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/PM/">PM</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Atlassian公司简介："><a href="#Atlassian公司简介：" class="headerlink" title="Atlassian公司简介："></a>Atlassian公司简介：</h1><p>官网: <a href="https://www.atlassian.com" target="_blank" rel="noopener">https://www.atlassian.com</a><br>Atlassian, inspired by the Greek Titan. list on the NASDAQ under TEAM 2015.<br>Mission: Move work forward. Atlassian helps teams work smarter and faster, together.</p>
<hr>
<h1 id="主要产品："><a href="#主要产品：" class="headerlink" title="主要产品："></a>主要产品：</h1><table>
<thead>
<tr>
<th style="text-align:left">产品名称</th>
<th style="text-align:left">简介</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Jira</td>
<td style="text-align:left">Project and issue tracking</td>
<td style="text-align:left">项目管理系统</td>
</tr>
<tr>
<td style="text-align:left">Confluence</td>
<td style="text-align:left">Document collaboration</td>
<td style="text-align:left">知识库系统</td>
</tr>
<tr>
<td style="text-align:left">Trello</td>
<td style="text-align:left">Collaborate visually on any project</td>
<td style="text-align:left">简单的团队协作系统<br>适合个人或者小团队使用</td>
</tr>
<tr>
<td style="text-align:left">Bitbucket</td>
<td style="text-align:left">Git code management</td>
<td style="text-align:left">代码库托管系统<br>支持权限管理/code review等等<br>类比Github</td>
</tr>
<tr>
<td style="text-align:left">Bamboo</td>
<td style="text-align:left">Integration and release management</td>
<td style="text-align:left">自动化系统<br>类比Jenkins</td>
</tr>
<tr>
<td style="text-align:left">Sourcetree</td>
<td style="text-align:left">Git and Mercurial desktop client</td>
<td style="text-align:left">git客户端</td>
</tr>
<tr>
<td style="text-align:left">Fisheye</td>
<td style="text-align:left">Search, monitor, and track across SVN, Git, and Perforce repositories</td>
<td style="text-align:left">代码库查询展示系统<br>支持多种代码库</td>
</tr>
<tr>
<td style="text-align:left">Crucible</td>
<td style="text-align:left">Find bugs and improve code quality through peer code review</td>
<td style="text-align:left">code review系统<br>类比Phabricator</td>
</tr>
</tbody>
</table>
<hr>
<h1 id="产品形态"><a href="#产品形态" class="headerlink" title="产品形态"></a>产品形态</h1><table>
<thead>
<tr>
<th style="text-align:left">类型</th>
<th style="text-align:left">简介</th>
<th style="text-align:left">优点</th>
<th style="text-align:left">缺点</th>
<th style="text-align:left">适用场景</th>
<th style="text-align:left">付款策略</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Cloud</td>
<td style="text-align:left">ATLASSIAN公司搭建运维云服务</td>
<td style="text-align:left">1.开箱即用<br>2.运维容灾由ATLASSIAN公司保障<br>3.新版本升级支持<br>4.日常使用问题支持</td>
<td style="text-align:left">1. 国内访问速度慢<br>2. 数据托管在cloud</td>
<td style="text-align:left">1.快速使用 <br>2.多地点使用<br>3.运维能力一般</td>
<td style="text-align:left">per year</td>
</tr>
<tr>
<td style="text-align:left">Server</td>
<td style="text-align:left">公司自行搭建运维服务</td>
<td style="text-align:left">1.自行定制配置搭建<br>2.数据信息存储在自家服务器上<br>3.访问速度快</td>
<td style="text-align:left">自行负责运维（服务/网络）</td>
<td style="text-align:left">1.数据保密/安全要求较高<br>2.运维能力较强团队</td>
<td style="text-align:left">one-time payment<br>服务可以一直使用<br>包含12个月内的新版本升级支持<br>如果12个月后还想升级版本的话，需要重新付费</td>
</tr>
<tr>
<td style="text-align:left">Data Center</td>
<td style="text-align:left">公司自行搭建运维服务<br>官方提供扩展数据/服务容灾支持</td>
<td style="text-align:left">1.数据多节点存储<br>2.负载均衡<br>3.集群支持</td>
<td style="text-align:left">价格太贵了</td>
<td style="text-align:left">1.大中型企业级用户（500+）<br>2.容灾安全/负载均衡要求较高<br>3.跨多地区团队</td>
<td style="text-align:left">per year</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="工具链选型"><a href="#工具链选型" class="headerlink" title="工具链选型"></a>工具链选型</h2><ol>
<li>项目管理系统： Jira Server</li>
<li>公司知识库系统： Confluence Server</li>
<li>公司代码库： Bitbucket/Git（code review）</li>
<li>自动化平台： Jenkins （Bamboo正在内部试用调研）</li>
</ol>
<hr>
<h2 id="选型思路"><a href="#选型思路" class="headerlink" title="选型思路"></a>选型思路</h2><p>0.为什么是Jira Server？</p>
<ul>
<li>公司项目研发团队在中国，Cloud访问速度慢；</li>
<li>公司现有研发体量不需要过度支持，所以不考虑Data Center；</li>
<li>运维团队比较强力，可以做到服务器高可用支持；</li>
<li>IOS/Android 客户端支持；</li>
<li>流程/字段定制功能强大，项目支持方便。</li>
</ul>
<p>1.为什么是Confluence Server？</p>
<ul>
<li>和Jira打通非常方便，联动性很好；</li>
<li>系统自带的模版页面非常适合特定场景使用；</li>
<li>易用性很好，学习成本很低；</li>
<li>多人协同编辑可视化很好；</li>
<li>IOS/Android 客户端支持</li>
</ul>
<p>2.为什么是Bitbucket Server？</p>
<ul>
<li>原有的Gerrit版本比较老，易用性不好；</li>
<li>Gitlab / Bitbucket 都可以满足团队代码托管 / code review / 系统集成的需要；</li>
<li>选择 Bitbucket 主要是和Jira &amp;&amp; Confluence原生打通非常方便，联动性很好；</li>
<li>源代码是公司核心资产，从安全性考虑，暂时不准备开放公网访问。</li>
</ul>
<p>3.为什么是Jenkins？</p>
<ul>
<li>已经使用Jenkins很长时间了，团队人员比较熟悉；</li>
<li>通过二次开发，Jenkins能满足当前项目使用；</li>
<li>Bamboo 在Jira &amp;&amp; Bitbucket联动性上会比Jenkins好；</li>
<li>Bamboo是根据挂载的Remote agents数量进行收费，Jenkins是免费的；</li>
<li>因为项目特殊性，需要用到多Slave挂载，从成本角度考虑还是使用Jenkins更适合。</li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/posts/43943/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/posts/42921/"
                            aria-label=": Gerrit LDAP: Allow to configure multiple accountBase and groupBase values"
                        >
                            Gerrit LDAP: Allow to configure multiple accountBase and groupBase values
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-10-11T11:46:37+08:00">
	
		    Oct 11, 2019
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/SCM/">SCM</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h3><ul>
<li>Gerrit官方文档: <a href="https://www.gerritcodereview.com/config-gerrit.html" target="_blank" rel="noopener">Gerritcodereview</a></li>
<li>Github issue: <a href="https://github.com/kbrebanov/ansible-gerrit/issues/15" target="_blank" rel="noopener">Github</a></li>
</ul>
<h2 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h2><p>搭建了Openldap维护公司域账户信息，Gerrit用户验证接入了LDAP。<br>gerrit.config配置如下（信息请更新为各自公司节点）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ldap]</span><br><span class="line">  server = ldap://ldap.example.com</span><br><span class="line">  username = ldapuser</span><br><span class="line">  accountBase = ou=people,dc=example,dc=com</span><br><span class="line">  groupBase = ou=groups,dc=example,dc=com</span><br></pre></td></tr></table></figure></p>
<h2 id="业务需求："><a href="#业务需求：" class="headerlink" title="业务需求："></a>业务需求：</h2><p>公司特定合作伙伴 有 访问代码库 进行 联合开发的需求。</p>
<h2 id="方案设计："><a href="#方案设计：" class="headerlink" title="方案设计："></a>方案设计：</h2><ol>
<li>在现有LDAP节点的基础上，增加一个ou（custom），用来维护合作伙伴账号；</li>
<li>同步 这个ou（custom）的人员到Gerrit上。</li>
</ol>
<hr>
<h2 id="配置Gerrit支持多ou-user信息："><a href="#配置Gerrit支持多ou-user信息：" class="headerlink" title="配置Gerrit支持多ou user信息："></a>配置Gerrit支持多ou user信息：</h2><p>根据Gerrit官方文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ldap.accountBase</span><br><span class="line">    Root of the tree containing all user accounts. This is typically of the form ou=people,dc=example,dc=com.</span><br><span class="line">    This setting may be added multiple times to specify more than one root.</span><br></pre></td></tr></table></figure></p>
<p>我们调整gerrit.config配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ldap]</span><br><span class="line">  server = ldap://ldap.example.com</span><br><span class="line">  username = ldapuser</span><br><span class="line">  accountBase = ou=people,dc=example,dc=com</span><br><span class="line">  accountBase = ou=custom,dc=example,dc=com</span><br><span class="line">  groupBase = ou=groups,dc=example,dc=com</span><br></pre></td></tr></table></figure></p>
<p>然后重启Gerrit后，custom里面的人员也可以登录Gerrit了。</p>
<hr>
<h2 id="配置Gerrit支持多group信息："><a href="#配置Gerrit支持多group信息：" class="headerlink" title="配置Gerrit支持多group信息："></a>配置Gerrit支持多group信息：</h2><p>方法和上面同步多个ou user信息相似，增加ldap.groupBase行即可。<br>根据Gerrit官方文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ldap.groupBase</span><br><span class="line">    Root of the tree containing all group objects. This is typically of the form ou=groups,dc=example,dc=com.</span><br><span class="line">    This setting may be added multiple times to specify more than one root.</span><br></pre></td></tr></table></figure></p>
<h3 id="关于LDAP-group信息："><a href="#关于LDAP-group信息：" class="headerlink" title="关于LDAP group信息："></a>关于LDAP group信息：</h3><p>一般系统接入LDAP做账户验证，只需同步LDAP的user信息，不直接使用LDAP的group信息。<br>各个系统自行创建系统组进行人员权限管理，这样更加灵活。<br>同时，也不建议LDAP里面维护太多group，更加推荐LDAP轻量化使用。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/posts/42921/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/posts/31267/"
                            aria-label=": Git tips two"
                        >
                            Git tips two
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-09-23T18:51:04+08:00">
	
		    Sep 23, 2019
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/SCM/">SCM</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="软件版本："><a href="#软件版本：" class="headerlink" title="软件版本："></a>软件版本：</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git version 2.23.0</span><br></pre></td></tr></table></figure>
<h2 id="使用http-https协议代码库地址，有时会出现不能存储密码，每次交互操作都需要输入帐户密码情况："><a href="#使用http-https协议代码库地址，有时会出现不能存储密码，每次交互操作都需要输入帐户密码情况：" class="headerlink" title="使用http/https协议代码库地址，有时会出现不能存储密码，每次交互操作都需要输入帐户密码情况："></a>使用http/https协议代码库地址，有时会出现不能存储密码，每次交互操作都需要输入帐户密码情况：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">记住密码（默认15分钟）：git config --global credential.helper cache</span><br><span class="line">自己定义时间（一小时后失效）：git config credential.helper &apos;cache --timeout=3600&apos;</span><br><span class="line">永久存储密码：git config --global credential.helper store</span><br></pre></td></tr></table></figure>
<h2 id="行结束符处理："><a href="#行结束符处理：" class="headerlink" title="行结束符处理："></a>行结束符处理：</h2><table>
<thead>
<tr>
<th>OS</th>
<th style="text-align:center">Line Endings</th>
<th style="text-align:right">Comments</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows</td>
<td style="text-align:center">CRLF</td>
<td style="text-align:right">每行结尾是 &lt;换行&gt;&lt;回车 &gt; ，即 \n\r</td>
</tr>
<tr>
<td>Mac OS X</td>
<td style="text-align:center">LF</td>
<td style="text-align:right">每行结尾只有 &lt;换行&gt; ，即 \n</td>
</tr>
<tr>
<td>Unix/Linux</td>
<td style="text-align:center">LF</td>
<td style="text-align:right">每行结尾只有 &lt;换行&gt; ，即 \n</td>
</tr>
<tr>
<td>Classic macOS</td>
<td style="text-align:center">CR</td>
<td style="text-align:right">每行结尾是 &lt;回车&gt;，即 \r</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">排除老Mac系统不讨论，项目组如果不是全Windows环境开发/部署的话，还是要自动处理下行结束符。</span><br><span class="line"></span><br><span class="line"># Windows用户执行下面配置命令：</span><br><span class="line">$ git config --global core.autocrlf true # 在提交时自动地把行结束符CRLF转换成LF，而在签出代码时把LF转换成CRLF</span><br><span class="line"></span><br><span class="line"># Linux 和 Mac用户执行下面配置命令：（预防代码库已经有CRLF结束符的代码）</span><br><span class="line">$ git config --global core.autocrlf input # 在提交时把CRLF转换成LF，签出时不转换</span><br><span class="line"></span><br><span class="line"># 默认配置：</span><br><span class="line">$ git config --global core.autocrlf false # 提交和签出时都不对代码行结束符做转换</span><br></pre></td></tr></table></figure>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/posts/31267/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/posts/1056/"
                            aria-label=": Git 历史删除文件"
                        >
                            Git 历史删除文件
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-07-18T15:23:19+08:00">
	
		    Jul 18, 2018
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/SCM/">SCM</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h1><ul>
<li>Github: <a href="https://help.github.com/articles/removing-files-from-a-repository-s-history/" target="_blank" rel="noopener">Removing files from a repository’s history</a></li>
<li>Github: <a href="https://help.github.com/articles/removing-sensitive-data-from-a-repository/" target="_blank" rel="noopener">Removing sensitive data from a repository
</a></li>
<li>Git-scm: <a href="https://git-scm.com/docs/git-filter-branch" target="_blank" rel="noopener">git-filter-branch</a></li>
<li>bfg-repo-cleaner: <a href="https://rtyley.github.io/bfg-repo-cleaner/" target="_blank" rel="noopener">bfg-repo-cleaner</a></li>
</ul>
<hr>
<h1 id="场景1"><a href="#场景1" class="headerlink" title="场景1:"></a>场景1:</h1><p>最新的一个提交版本里面新增了敏感、较大、无意义的文件，需要进行清理。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. 删除文件</span><br><span class="line">    $ git rm --cached $&#123;文件绝对地址&#125;</span><br><span class="line">2. 增加到上述文件到 .gitignore</span><br><span class="line">    $ vim .gitignore</span><br><span class="line">3. 修复最新提交版本</span><br><span class="line">    $ git commit --amend</span><br><span class="line">4. 推送新版本到远端仓库</span><br><span class="line">    如果刚才版本已经推送到远端仓库：</span><br><span class="line">        $ git push -f</span><br><span class="line">    如果刚才版本只是在本地仓库：</span><br><span class="line">        $ git push</span><br></pre></td></tr></table></figure></p>
<hr>
<h1 id="场景2"><a href="#场景2" class="headerlink" title="场景2:"></a>场景2:</h1><p>历史版本里面存在敏感、较大、无意义的文件，需要进行清理。</p>
<h3 id="使用-git-filter-branch"><a href="#使用-git-filter-branch" class="headerlink" title="使用 git filter-branch"></a>使用 git filter-branch</h3><p>git 原生提供的命令，如果没有的话，请先升级机器git版本。</p>
<ul>
<li>原理：<br>  扫描代码库所有版本<pre><code>如果某个版本里面发现了指定的文件OR目录：
    如果此版本包含要清理的文件OR目录 和 其它变更的话，对此版本进行删除指定文件OR目录（保留其它变更），并生成新的版本。同时后面的版本会变基到新版本。
    如果此版本只包含要清理的文件OR目录变更的话，那么此版本会被清除。同时后面的版本会变基到上一个版本。
如果版本没有包含指定文件OR目录，那么继续遍历。
</code></pre></li>
<li>PS：<ol>
<li>如果代码库历史比较多 OR 涉及到指定文件OR目录的版本比较多，那么命令执行会比较慢。</li>
<li>一般会导致代码库版本树变化，对于涉及开发同学，建议开始前提交本地修改变更到远端仓库，完成后本机重新clone代码库进行开发。</li>
<li>一般都在本地仓库根目录执行</li>
<li>执行命令后历史版本里面已经清理了文件, 但是我们的本地仓库里面仍然保留了这些objects, 等待垃圾回收(GC), 如果想立即回收本地仓库空间可以执行 git gc –prune=now.</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1. 执行命令</span><br><span class="line">    $ git filter-branch --force --index-filter &apos;git rm --cached -r --ignore-unmatch $&#123;要清理的文件OR目录的绝对地址&#125;&apos; --prune-empty --tag-name-filter cat -- --all</span><br><span class="line">2. 增加到上述文件OR目录到 .gitignore</span><br><span class="line">    $ vim .gitignore</span><br><span class="line">3. 推送新版本到远端仓库</span><br><span class="line">    $ git push -f --all</span><br><span class="line">    $ git push -f --tags</span><br><span class="line">4. 清理本地仓库残留的git objects</span><br><span class="line">    $ git reflog expire --expire=now --all</span><br><span class="line">    $ git gc --prune=now</span><br></pre></td></tr></table></figure>
<h3 id="使用-bfg-repo-cleaner"><a href="#使用-bfg-repo-cleaner" class="headerlink" title="使用 bfg-repo-cleaner"></a>使用 bfg-repo-cleaner</h3><p>Roberto Tyley使用Scala语言写了 bfg-repo-cleaner工具。<br>可以简单理解为一个轻量级的 git filter-branch。<br>使用比较简单，功能比较强大，只需要下载最新的jar包，然后执行👇命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 删除大于50M的文件</span><br><span class="line">$ java -jar bfg.jar --no-blob-protection --strip-blobs-bigger-than 50M</span><br><span class="line"># 删除指定文件</span><br><span class="line">$ java -jar bfg.jar --no-blob-protection --delete-files $&#123;要清理的文件的绝对地址&#125;</span><br></pre></td></tr></table></figure></p>
<p>PS:</p>
<pre><code>1. bfg-repo-cleaner 有个protect功能，默认HEAD是受保护的。
    受保护的分支最新版本如果涉及需要清理文件，那么并不会成功。
    --no-blob-protection  关闭protect功能
    --protect-blobs-from ${分支1},${分支2} 增加受保护的分支
2. 建议在本地仓库根目录执行。
</code></pre><hr>
<h1 id="场景3"><a href="#场景3" class="headerlink" title="场景3:"></a>场景3:</h1><p>查找代码库里面较大文件方法：</p>
<pre><code>- 如果当前版本还存在的文件，可以直接du排序来识别；
- 如果当前版本不存在，但是历史中出现过的大文件，可以按照下面步骤来查询。
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 显示比较大的pack</span><br><span class="line">$ du -ah .git/objects/pack</span><br></pre></td></tr></table></figure>
<p><img src="/posts/1056/git1.png" alt="logo"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2. 识别object,对输出的第三列信息即文件大小进行排序</span><br><span class="line">$ git verify-pack -v .git/objects/pack/$&#123;pack-XXX.pack&#125; | sort -k 3 -n | tail -5</span><br></pre></td></tr></table></figure></p>
<p><img src="/posts/1056/git2.png" alt="logo"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3. 识别object对应的文件</span><br><span class="line">$ git rev-list --objects --all | grep $&#123;👆获取的object&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/posts/1056/git3.png" alt="logo"></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/posts/1056/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/posts/20597/"
                            aria-label=": Nexus3搭建npm私服"
                        >
                            Nexus3搭建npm私服
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-06-25T18:46:34+08:00">
	
		    Jun 25, 2018
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/SCM/">SCM</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h1><ul>
<li>官方文档：<a href="https://help.sonatype.com/repomanager3/node-packaged-modules-and-npm-registries" target="_blank" rel="noopener">node-packaged-modules-and-npm-registries</a></li>
</ul>
<h2 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h2><p>随着公司前端团队的扩大，需要拆分出公司基础模块供其它项目使用，使用Nexus3搭建公司npm私服。</p>
<h1 id="搭建步骤："><a href="#搭建步骤：" class="headerlink" title="搭建步骤："></a>搭建步骤：</h1><h3 id="1-创建npm库："><a href="#1-创建npm库：" class="headerlink" title="1. 创建npm库："></a>1. 创建npm库：</h3><p><img src="/posts/20597/npm_create1.png" alt="logo"><br><img src="/posts/20597/npm_create2.png" alt="logo"><br><img src="/posts/20597/npm_create3.png" alt="logo"><br><img src="/posts/20597/npm_create4.png" alt="logo"></p>
<h3 id="2-权限配置："><a href="#2-权限配置：" class="headerlink" title="2. 权限配置："></a>2. 权限配置：</h3><ul>
<li>激活 npm Bearer Token Realm<br><img src="/posts/20597/npm_realms.png" alt="logo"></li>
<li>创建开发权限组对hosted npm私服库读写权限<br><img src="/posts/20597/group.png" alt="logo"><br><img src="/posts/20597/group2.png" alt="logo"></li>
<li>创建dev帐户并加入到开发权限组<br><img src="/posts/20597/user.png" alt="logo"><br><img src="/posts/20597/user2.png" alt="logo"></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS: 匿名用户可以下载私服npm包，只有dev组内的帐户才能publish包到hosted私服</span><br></pre></td></tr></table></figure>
<h1 id="使用："><a href="#使用：" class="headerlink" title="使用："></a>使用：</h1><h3 id="1-配置nexus私服"><a href="#1-配置nexus私服" class="headerlink" title="1.配置nexus私服"></a>1.配置nexus私服</h3><ul>
<li><p>查看本机私服配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm config get registry</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置本机配置到group私服：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm config set registry http://$&#123;ip&#125;:8081/repository/$&#123;npm_group&#125;/</span><br><span class="line">       （写入到本机.npmrc文件）</span><br></pre></td></tr></table></figure>
</li>
<li><p>此时，项目执行npm install即从nexus上面进行下载包</p>
</li>
</ul>
<h3 id="2-配置publish帐户"><a href="#2-配置publish帐户" class="headerlink" title="2.配置publish帐户"></a>2.配置publish帐户</h3><p>有👇两种方式</p>
<ul>
<li><p>Authentication Using Realm and Login</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> $ npm login --registry=http://$&#123;ip&#125;:8081/repository/$&#123;npm_hosted&#125;/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Username: dev （各位根据上面创建的帐户自行替换）</span><br><span class="line">Password: $&#123;dev_pass&#125; （各位根据上面创建的密码自行替换）</span><br><span class="line">Email: (this IS public) XXX@XXX.com (各位根据上面创建的邮箱自行替换)</span><br><span class="line"></span><br><span class="line">Logged in as dev on http://$&#123;ip&#125;:8081/repository/$&#123;npm_hosted&#125;/.</span><br><span class="line">        （写入到本机.npmrc文件）</span><br></pre></td></tr></table></figure>
</li>
<li><p>Authentication Using Basic Auth</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> $ echo -n &apos;dev:$&#123;dev_pass&#125;&apos; | openssl base64  （dev帐户密码base64编码）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">本机.npmrc文件里面增加👇行</span><br><span class="line"></span><br><span class="line">email=XXX@XXX.com</span><br><span class="line">always-auth=true</span><br><span class="line">_auth=$&#123;base64编码后的值&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="3-推送npm包到nexus"><a href="#3-推送npm包到nexus" class="headerlink" title="3.推送npm包到nexus"></a>3.推送npm包到nexus</h3><p>有👇两种方式</p>
<ul>
<li><p>命令行 + 发布路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm publish –registry http://$&#123;ip&#125;:8081/repository/$&#123;npm_hosted&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>package.json配置发布路径（推荐）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">项目package.json增加👇配置：</span><br><span class="line"></span><br><span class="line">&quot;publishConfig&quot; : &#123;</span><br><span class="line">  &quot;registry&quot; : &quot;http://$&#123;ip&#125;:8081/repository/$&#123;npm_hosted&#125;/&quot;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">执行👇命令即可</span><br><span class="line">$ npm publish</span><br></pre></td></tr></table></figure>
</li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/posts/20597/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/posts/17688/"
                            aria-label=": maven Tips - force update"
                        >
                            maven Tips - force update
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-05-14T16:14:11+08:00">
	
		    May 14, 2018
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/SCM/">SCM</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="localRepository机制："><a href="#localRepository机制：" class="headerlink" title="localRepository机制："></a>localRepository机制：</h3><ul>
<li><a href="http://maven.apache.org/guides/introduction/introduction-to-repositories.html" target="_blank" rel="noopener">introduction-to-repositories</a><br>The local repository refers to a copy on your own installation that is a cache of the remote downloads, and also contains the temporary build artifacts that you have not yet released.</li>
</ul>
<ul>
<li><p>settings.xml配置：</p>
<pre><code>&lt;!-- localRepository
    | The path to the local repository maven will use to store artifacts.
    |
    | Default: ${user.home}/.m2/repository
--&gt;
&lt;localRepository&gt;/path/to/local/repo&lt;/localRepository&gt;
</code></pre></li>
<li><p>使用场景：</p>
<ul>
<li>maven执行编译打包时先进行依赖的下载：</li>
<li>如果项目依赖localRepository中已经存在，那么继续进行编译打包；</li>
<li>如果项目依赖localRepository中不存在，那么先下载依赖到localRepository，然后进行编译打包；</li>
</ul>
</li>
</ul>
<h3 id="强制更新SNAPSHOT版本依赖："><a href="#强制更新SNAPSHOT版本依赖：" class="headerlink" title="强制更新SNAPSHOT版本依赖："></a>强制更新SNAPSHOT版本依赖：</h3><ul>
<li><a href="https://maven.apache.org/settings.html#Repositories" target="_blank" rel="noopener">snapshots updatePolicy</a><ul>
<li>updatePolicy: This element specifies how often updates should attempt to occur. Maven will compare the local POM’s timestamp (stored in a repository’s maven-metadata file) to the remote. The choices are: always, daily (default), interval:X (where X is an integer in minutes) or never.</li>
</ul>
</li>
<li>👇场景下需要强制更新：<ul>
<li>默认snapshot版本依赖localRepository更新是天级的。如果项目联调阶段一天之内多次snapshot依赖更新。</li>
<li>如果项目下载依赖过程中断（常见网络原因），导致localRepository中的文件状态有问题。</li>
</ul>
</li>
</ul>
<pre><code>mvn clean package -U

-U,--update-snapshots                  
        Forces a check for missing releases and updated snapshots on remote repositories
</code></pre><h3 id="强制更新RELEASE和SNAPSHOT版本依赖："><a href="#强制更新RELEASE和SNAPSHOT版本依赖：" class="headerlink" title="强制更新RELEASE和SNAPSHOT版本依赖："></a>强制更新RELEASE和SNAPSHOT版本依赖：</h3><ul>
<li><p>👇场景建议使用强制更新：</p>
<ul>
<li>如果项目下载依赖过程中断（常见网络原因），导致localRepository中的文件状态有问题。</li>
</ul>
</li>
<li><p>方法：</p>
<ul>
<li>简单粗暴型：直接清空localRepository，然后执行编译打包重新下载依赖。</li>
<li>推荐精细型：定向删除localRepository中 本次项目涉及依赖，然后重新下载：</li>
</ul>
</li>
</ul>
<pre><code>mvn dependency:purge-local-repository

    tells Maven to clear all dependency-artifact files out of the local repository, and optionally re-resolve them.
</code></pre>
                    
                        


                    
                    
                        <p>
                            <a
                                href="/posts/17688/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/posts/27558/"
                            aria-label=": Nexus3批量导入jar包"
                        >
                            Nexus3批量导入jar包
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-03-28T19:19:17+08:00">
	
		    Mar 28, 2018
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/SCM/">SCM</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h1><ul>
<li><a href="https://support.sonatype.com/hc/en-us/articles/115006744008-How-can-I-programmatically-upload-an-artifact-into-Nexus-3-" target="_blank" rel="noopener">How can I programmatically upload an artifact into Nexus 3?</a></li>
<li><a href="https://gist.github.com/DarthHater/a4f2738e3bd40d242db22633b59dfd63" target="_blank" rel="noopener">Nexus Repository Import Script
</a></li>
</ul>
<h1 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h1><p>已经搭建Nexus3.6.0，需要迁移原有 两个 nexus2上的jar包 到nexus3统一管理。</p>
<h3 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h3><ul>
<li>Nexus2.x 服务器直接存储jar包</li>
<li>Nexus3.x 服务器存储的是二进制文件</li>
<li>所以不能通过 copy原Nexus2.x服务器上的 repositories目录 到nexus3.X，刷新index方式来迁移。</li>
</ul>
<h3 id="迁移导入方法："><a href="#迁移导入方法：" class="headerlink" title="迁移导入方法："></a>迁移导入方法：</h3><ol>
<li><p><a href="https://help.sonatype.com/display/NXRM3/Upgrading" target="_blank" rel="noopener">官方Upgrading</a><br> 具体实施可以参考上一篇blog。<br> 这种方法有两个小问题：</p>
<pre><code>- 需要原nexus版本为2.14.x版本
- 每个nexus2导入都会在nexus3上面都会创建一个仓库，不适合有多个nexus2统一迁移到一个nexus3
</code></pre></li>
<li><p>mvn deploy命令上传<br> 如果原nexus2待迁移的jar包并不多，可以使用这种方式。</p>
<pre><code>1. 只上传jar，自动生成pom.xml （独立jar，pom不需要依赖其它）
mvn deploy:deploy-file -DgroupId=$groupId -DartifactId=$artifactId -Dversion=$version -Dpackaging=jar -DrepositoryId=nexus -Durl=http://$ip:8081/repository/$repository_name -Dfile=$path/XX.jar

2. 上传jar 和 pom.xml (pom里面有依赖)
mvn deploy:deploy-file -DgroupId=$groupId -DartifactId=$artifactId -Dversion=$version -DgeneratePom=false -Dpackaging=jar -DrepositoryId=nexus -Durl=http://$ip:8081/repository/$repository_name -DpomFile=$path/pom.xml -Dfile=$path/XX.jar
</code></pre><p> 需要注意：</p>
<pre><code>- 命令里面-DrepositoryId=nexus对应的是本机mvn settings.xml文件配置&lt;server&gt; &lt;id&gt;
- 写脚本封装上面命令实现批量迁移
</code></pre></li>
<li><p>http协议上传<br> 直接使用http put 文件到/repository/$repo-id/$path-of-file</p>
<pre><code>curl -v -u admin:admin123 --upload-file pom.xml http://$ip:8081/repository/maven-releases/org/foo/1.0/foo-1.0.pom
</code></pre><p> 我们需要上传的文件：jar和pom.xml</p>
<p> 创建 mavenimport.sh 脚本如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># Get command line params</span><br><span class="line">while getopts &quot;:r:u:p:&quot; opt; do</span><br><span class="line">    case $opt in</span><br><span class="line">        r) REPO_URL=&quot;$OPTARG&quot;</span><br><span class="line">        ;;</span><br><span class="line">        u) USERNAME=&quot;$OPTARG&quot;</span><br><span class="line">        ;;</span><br><span class="line">        p) PASSWORD=&quot;$OPTARG&quot;</span><br><span class="line">        ;;</span><br><span class="line">        esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">find . -type f -not -path &apos;*/\.*&apos; -not -path &apos;*/\^archetype\-catalog\.xml*&apos; -not -path &apos;*/\^maven\-metadata\-local*\.xml&apos; -not -path &apos;*/\^maven\-metadata\-deployment*\.xml&apos; -exec curl -u $USERNAME:$PASSWORD -X PUT -v -T &#123;&#125; $REPO_URL&#123;&#125; \;</span><br></pre></td></tr></table></figure>
<p> 登陆到Nexus2.x服务器执行</p>
<pre><code>cd $releases_dir
cp $path/mavenimport.sh .
sh mavenimport.sh -u admin -p admin123 -r http://$ip:8081/repository/$release_repository_name

cd $snapshots_dir
cp $path/mavenimport.sh .
sh mavenimport.sh -u admin -p admin123 -r http://$ip:8081/repository/$snapshots_repository_name
</code></pre><p> 需要注意：</p>
<pre><code>- 上面命令里面 -u admin -p admin123 请更换成nexus管理员帐户密码 （nexus默认管理员/密码 admin/admin123）
- 上面命令里面 $releases_dir 是指Nexus2.x服务器上存储releases仓库路径。
- 上面命令里面 $snapshots_dir 是指Nexus2.x服务器上存储snapshots仓库路径。
- 如果不切换到上面目录里面，那么上传的jar包 group_id会有问题。
</code></pre></li>
</ol>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/posts/27558/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
          <li class="pagination-next">
            <a
                class="btn btn--default btn--small"
                href="/archives/page/2/"
                aria-label="OLDER POSTS"
            >
              <span>OLDER POSTS</span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
        <li class="pagination-number">page 1 of 3</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Weilong. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/owl.png" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Weilong</h4>
        
            <div id="about-card-bio"> <ul> Write something about work and life: <ul class="nav pull-left"> <li align="left">Project management</li> <li align="left">Configuration management</li> <li align="left">Process improvement</li> <li align="left">Continuous deploy</li> <li align="left">Python program</li> </ul><br></ul> </div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>PM</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Shenzhen
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/jquery.js"></script>
<script src="/assets/js/jquery.fancybox.js"></script>
<script src="/assets/js/thumbs.js"></script>
<script src="/assets/js/tranquilpeak.js"></script>
<!--SCRIPTS END-->





    </body>
</html>
